###############################################################################
#
# IAR ANSI C/C++ Compiler V7.50.1.10123/W32 for ARM       26/Dec/2017  20:53:06
# Copyright 1999-2015 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  
#        F:\iar\NC199B-100\Library\Source\APP\Tasks\APP_task_osal_store.c
#    Command line =  
#        F:\iar\NC199B-100\Library\Source\APP\Tasks\APP_task_osal_store.c -D
#        USE_STDPERIPH_DRIVER -D STM32F10X_CL -D DEBUG -D IMAGE_A -D
#        STM32F103RC -D STM32_FLASH_SIZE=256 -D HSE_VALUE=25000000 -lCN
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\List\
#        -o
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\Obj\
#        --no_unroll --no_inline --no_tbaa --no_scheduling --debug
#        --endian=little --cpu=Cortex-M3 -e --fpu=None --dlib_config
#        "C:\Program Files (x86)\IAR Systems\Embedded Workbench
#        7.3\arm\INC\c\DLib_Config_Full.h" -I
#        F:\iar\NC199B-100\Library\Project\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\AES\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Config\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Port\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\OS\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Config\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Protocol\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Iap\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Driver\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\uCOS-III\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\CoreSupport\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\DeviceSupport\ST\STM32F10x\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\STM32F10x_StdPeriph_Driver\inc\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\ARM-Cortex-M3\IAR\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-LIB\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\OSAL\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\OSAL\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Cfg\Template\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\OS\uCOS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Ports\ARM-Cortex-M3\Generic\IAR\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Source\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\option\ -Om
#        --use_c++_inline -I "C:\Program Files (x86)\IAR Systems\Embedded
#        Workbench 7.3\arm\CMSIS\Include\"
#    List file    =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\List\APP_task_osal_store.lst
#    Object file  =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\Obj\APP_task_osal_store.o
#
###############################################################################

F:\iar\NC199B-100\Library\Source\APP\Tasks\APP_task_osal_store.c
      1          /*******************************************************************************
      2           *   Filename:       app_task_store.c
      3           *   Revised:        All copyrights reserved to redmorningcn.
      4           *   Revision:       v1.0
      5           *   Writer:	     redmorningcn.
      6           *
      7           *   Description:    双击选中 store 按 Ctrl + H, 钩选 Match the case, Replace with
      8           *                   输入您要的名字，点击 Replace All
      9           *                   双击选中 Store 按 Ctrl + H, 钩选 Match the case, Replace with
     10           *                   输入您要的名字，点击 Replace All
     11           *                   双击选中 STORE 按 Ctrl + H, 钩选 Match the case, Replace with
     12           *                   输入您要的名字，点击 Replace All
     13           *                   在 app_cfg.h 中指定本任务的 优先级  （ APP_TASK_STORE_PRIO ）
     14           *                                            和 任务堆栈（ APP_TASK_STORE_STK_SIZE ）大小
     15           *                   在 app.h 中声明本任务的     创建函数（ void  App_TaskStoreCreate(void) ）
     16           *                                            和 看门狗标志位 （ WDTFLAG_Store ）
     17           *
     18           *   Notes:
     19           *     				E-mail: redmorningcn@qq.com
     20           *
     21           *******************************************************************************/
     22          
     23          /*******************************************************************************
     24           * INCLUDES
     25           */
     26          #define  SNL_APP_SOURCE
     27          #include <includes.h>
     28          #include <global.h>
     29          #include <app_ctrl.h>
     30          #include <cpu.h>
     31          //#include <bsp_mx25.h>
     32          #include <bsp_FRAM.h>
     33          #include <bsp_DS3231.h>
     34          #include <MX25L1602Drv.h>
     35          
     36               
     37          
     38          #ifdef VSC_INCLUDE_SOURCE_FILE_NAMES
     39          const  CPU_CHAR  *app_task_store__c = "$Id: $";
     40          #endif
     41          
     42          #define APP_TASK_STORE_EN     DEF_ENABLED
     43          #if APP_TASK_STORE_EN == DEF_ENABLED				//
     44          /*******************************************************************************
     45           * CONSTANTS
     46           */
     47          
     48          /*******************************************************************************
     49           * MACROS
     50           */
     51          #define		START_EVT		31		
     52          
     53          /*******************************************************************************
     54           * TYPEDEFS
     55           */
     56          
     57          /*******************************************************************************
     58           * LOCAL VARIABLES
     59           */
     60          
     61          #if ( OSAL_EN == DEF_ENABLED )
     62          #else
     63          /***********************************************
     64          * 描述： 任务控制块（TCB）
     65          */
     66          //static  OS_TCB   AppTaskStoreTCB;
     67          
     68          /***********************************************
     69          * 描述： 任务堆栈（STACKS）
     70          */
     71          //static  CPU_STK  AppTaskStoreStk[ APP_TASK_STORE_STK_SIZE ];
     72          
     73          #endif
     74          /*******************************************************************************
     75           * GLOBAL VARIABLES
     76           */
     77          
     78          /*******************************************************************************
     79           * LOCAL FUNCTIONS
     80           */
     81          #if ( OSAL_EN == DEF_ENABLED )
     82          #else
     83          extern	void    BSP_StoreInit(void);
     84          #endif
     85          
     86          /*******************************************************************************
     87           * GLOBAL FUNCTIONS
     88           */
     89          
     90          /*******************************************************************************
     91           * EXTERN VARIABLES
     92           */
     93          /*******************************************************************************/
     94          
     95          /*******************************************************************************
     96           * 名    称： 		GetRecNumAddr
     97           * 功    能：      取数据记录地址。
     98                          flash地址;更新记录号等信息。
     99           * 入口参数： 	无
    100           * 出口参数： 	无
    101           * 作　 　者： 	redmornigcn
    102           * 创建日期： 	2017-05-15
    103           * 修    改：
    104           * 修改日期：
    105           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    106          uint32  GetRecNumAddr(uint32 FlshRecNum)
    107          {				
    108              return  (uint32)(((FlshRecNum * sizeof(stcFlshRec)) % FLSH_MAX_SIZE)); 			
   \                     GetRecNumAddr: (+1)
   \   00000000   0x01C0             LSLS     R0,R0,#+7
   \   00000002   0x0240             LSLS     R0,R0,#+9
   \   00000004   0x0A40             LSRS     R0,R0,#+9
   \   00000006   0x4770             BX       LR               ;; return
    109          }
    110          
    111          
    112                
    113          /*******************************************************************************
    114           * 名    称：RoadNum;        		StoreData
    115           * 功    能：RelRoadNum;     		数据存储。根据数据记录号将数据存储到指定
    116           			StationNum;    		flash地址;更新记录号等信息。大部分数据记录的
    117           			E_StationNum;  		内容在其他任务直接对Ctrl.sRec 中更新。少部分
    118           					数据内容在该函数中跟新。
    119           * 入口参数：SignalTyp;      	无
    120           * 出口参数：LocoSign;       	无
    121           * 作　 　者                 ： 	redmornigcn
    122           * 创建日期：LocoWorkState;  	2017-05-15
    123           * 修    改：LocoState;     
    124           * 修改日期：
    125           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    126          void  StoreData(void)
    127          {	
   \                     StoreData: (+1)
   \   00000000   0xE92D 0x41FC      PUSH     {R2-R8,LR}
    128              stcTime             sTime;
    129              stcFlshRec          *sFlsh;
    130          
    131              // 	计算数据记录地址
    132              uint32  FlshAddr = GetRecNumAddr( Ctrl.Para.dat.sRecNumMgr.Current );	
   \   00000004   0x....             LDR.N    R4,??DataTable2
   \   00000006   0x1D25             ADDS     R5,R4,#+4
   \   00000008   0x682E             LDR      R6,[R5, #+0]
   \   0000000A   0x4630             MOV      R0,R6
   \   0000000C   0x.... 0x....      BL       GetRecNumAddr
   \   00000010   0x4607             MOV      R7,R0
    133          	
    134              sFlsh = &Ctrl.sRec;
    135          
    136              sFlsh->CmdTpye		 = 0;                                       //命令类型       1    
   \   00000012   0xF504 0x7880      ADD      R8,R4,#+256
   \   00000016   0x2000             MOVS     R0,#+0
   \   00000018   0xF888 0x0000      STRB     R0,[R8, #+0]
    137           
    138           //开机标示
    139              sFlsh->EvtType       =  0xff   ;                                //事件类型       1    
   \   0000001C   0x20FF             MOVS     R0,#+255
   \   0000001E   0xF888 0x0001      STRB     R0,[R8, #+1]
    140              if(Ctrl.Para.dat.sRunPara.StartFlg)
   \   00000022   0xF894 0x004B      LDRB     R0,[R4, #+75]
   \   00000026   0x2800             CMP      R0,#+0
   \   00000028   0xD005             BEQ.N    ??StoreData_0
    141              {
    142                  sFlsh->EvtType  = START_EVT;                                //_C          
   \   0000002A   0x201F             MOVS     R0,#+31
   \   0000002C   0xF888 0x0001      STRB     R0,[R8, #+1]
    143                  Ctrl.Para.dat.sRunPara.StartFlg = 0;
   \   00000030   0x2000             MOVS     R0,#+0
   \   00000032   0xF884 0x004B      STRB     R0,[R4, #+75]
    144              }   
    145              
    146              sFlsh->LocoType     =   Ctrl.Para.dat.sProductInfo.sLocoId.Type  ;//机车型号       2                  
   \                     ??StoreData_0: (+1)
   \   00000036   0x8B28             LDRH     R0,[R5, #+24]
   \   00000038   0xF8A8 0x0002      STRH     R0,[R8, #+2]
    147              sFlsh->LocoNum      =   Ctrl.Para.dat.sProductInfo.sLocoId.Num   ;//机 车 号       2                     
   \   0000003C   0x8B68             LDRH     R0,[R5, #+26]
   \   0000003E   0xF8A8 0x0004      STRH     R0,[R8, #+4]
    148              sFlsh->RecID        =   Ctrl.Para.dat.sRecNumMgr.Current;         //记录流水号     4                   
   \   00000042   0xF8C4 0x6106      STR      R6,[R4, #+262]
    149              //sFlsh->RunSys       =   Ctrl.Para.dat.sRunPara.SysSta;            //运行状态       1
    150              
    151              memcpy((uint8 *)&sFlsh->RunSys,(uint8 *)&Ctrl.Para.dat.sRunPara.SysSta,sizeof(sFlsh->RunSys));
   \   00000046   0x2201             MOVS     R2,#+1
   \   00000048   0xF104 0x014C      ADD      R1,R4,#+76
   \   0000004C   0xF504 0x7095      ADD      R0,R4,#+298
   \   00000050   0x.... 0x....      BL       __aeabi_memcpy
    152              
    153              ReadTime((stcTime *)&sTime);
   \   00000054   0x4668             MOV      R0,SP
   \   00000056   0x.... 0x....      BL       ReadTime
    154          	sFlsh->SysTime.Year =   sTime.Year;			
   \   0000005A   0xF89D 0x0005      LDRB     R0,[SP, #+5]
   \   0000005E   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   00000062   0xF360 0x619F      BFI      R1,R0,#+26,#+6
   \   00000066   0xF8C4 0x1138      STR      R1,[R4, #+312]
    155          	sFlsh->SysTime.Mon  =   sTime.Month;		
   \   0000006A   0xF89D 0x0004      LDRB     R0,[SP, #+4]
   \   0000006E   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   00000072   0xF360 0x5199      BFI      R1,R0,#+22,#+4
   \   00000076   0xF8C4 0x1138      STR      R1,[R4, #+312]
    156          	sFlsh->SysTime.Day  =   sTime.Date;			
   \   0000007A   0xF89D 0x0003      LDRB     R0,[SP, #+3]
   \   0000007E   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   00000082   0xF360 0x4155      BFI      R1,R0,#+17,#+5
   \   00000086   0xF8C4 0x1138      STR      R1,[R4, #+312]
    157          	sFlsh->SysTime.Hour =   sTime.Hour;			
   \   0000008A   0xF89D 0x0002      LDRB     R0,[SP, #+2]
   \   0000008E   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   00000092   0xF360 0x3110      BFI      R1,R0,#+12,#+5
   \   00000096   0xF8C4 0x1138      STR      R1,[R4, #+312]
    158          	sFlsh->SysTime.Min  =   sTime.Min;			
   \   0000009A   0xF89D 0x0001      LDRB     R0,[SP, #+1]
   \   0000009E   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   000000A2   0xF360 0x118B      BFI      R1,R0,#+6,#+6
   \   000000A6   0xF8C4 0x1138      STR      R1,[R4, #+312]
    159          	sFlsh->SysTime.Sec  =   sTime.Sec;	        
   \   000000AA   0xF89D 0x0000      LDRB     R0,[SP, #+0]
   \   000000AE   0xF8D4 0x1138      LDR      R1,[R4, #+312]
   \   000000B2   0xF360 0x0105      BFI      R1,R0,#+0,#+6
   \   000000B6   0xF8C4 0x1138      STR      R1,[R4, #+312]
    160          ////  数据记录内容更新在应用中进行。
    161          ////	数据内容存储在Ctrl.sRec 中。
    162          //         
    163              
    164          //  存储时更新的内容
    165              
    166          //  装置时间:年-月-日，时-分-秒
    167          	
    168              memset((uint8_t *)&sFlsh->Tax.buf1[0],0,sizeof(sFlsh->Tax.buf1));//clear
   \   000000BA   0x2200             MOVS     R2,#+0
   \   000000BC   0x2140             MOVS     R1,#+64
   \   000000BE   0xF504 0x709F      ADD      R0,R4,#+318
   \   000000C2   0x.... 0x....      BL       __aeabi_memset
    169              
    170              ReadTime((stcTime *)&sTime);
   \   000000C6   0x4668             MOV      R0,SP
   \   000000C8   0x.... 0x....      BL       ReadTime
    171          
    172          	sFlsh->Tax.Tax2.LKJTime.Year    = sTime.Year;			
   \   000000CC   0xF89D 0x0005      LDRB     R0,[SP, #+5]
   \   000000D0   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   000000D4   0xF360 0x619F      BFI      R1,R0,#+26,#+6
   \   000000D8   0xF8C4 0x115B      STR      R1,[R4, #+347]
    173          	sFlsh->Tax.Tax2.LKJTime.Mon	    = sTime.Month;		
   \   000000DC   0xF89D 0x0004      LDRB     R0,[SP, #+4]
   \   000000E0   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   000000E4   0xF360 0x5199      BFI      R1,R0,#+22,#+4
   \   000000E8   0xF8C4 0x115B      STR      R1,[R4, #+347]
    174          	sFlsh->Tax.Tax2.LKJTime.Day     = sTime.Date;			
   \   000000EC   0xF89D 0x0003      LDRB     R0,[SP, #+3]
   \   000000F0   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   000000F4   0xF360 0x4155      BFI      R1,R0,#+17,#+5
   \   000000F8   0xF8C4 0x115B      STR      R1,[R4, #+347]
    175          	sFlsh->Tax.Tax2.LKJTime.Hour    = sTime.Hour;			
   \   000000FC   0xF89D 0x0002      LDRB     R0,[SP, #+2]
   \   00000100   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   00000104   0xF360 0x3110      BFI      R1,R0,#+12,#+5
   \   00000108   0xF8C4 0x115B      STR      R1,[R4, #+347]
    176          	sFlsh->Tax.Tax2.LKJTime.Min     = sTime.Min;			
   \   0000010C   0xF89D 0x0001      LDRB     R0,[SP, #+1]
   \   00000110   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   00000114   0xF360 0x118B      BFI      R1,R0,#+6,#+6
   \   00000118   0xF8C4 0x115B      STR      R1,[R4, #+347]
    177          	sFlsh->Tax.Tax2.LKJTime.Sec     = sTime.Sec;			
   \   0000011C   0xF89D 0x0000      LDRB     R0,[SP, #+0]
   \   00000120   0xF8D4 0x115B      LDR      R1,[R4, #+347]
   \   00000124   0xF360 0x0105      BFI      R1,R0,#+0,#+6
   \   00000128   0xF8C4 0x115B      STR      R1,[R4, #+347]
    178          
    179          //    if(Ctrl.Tax.ConnectFlag == 1)                                  //收到tax箱信息，将数据复制到数据记录
    180          //    {
    181          //    // 	保存TAX箱信息 
    182          //        Ctrl.Tax.ConnectFlag = 0;                                  //清已取信息
    183          //
    184          ////        sFlsh->TaxType   = Ctrl.Tax.Dat.Tax2A.Record.Addr;
    185          ////        sFlsh->TaxFlg    = Ctrl.Tax.Dat.Tax2A.CheZhanHaoKuoChong;
    186          ////        memcpy((uint8_t *)&sFlsh->Tax.buf1[0],(uint8_t *)&Ctrl.Tax.Dat.buf1[6],64);
    187          //    }
    188          //    
    189          // 	计算记录校验和
    190          	sFlsh->CrcCheck = GetCrc16Check((uint8 *)sFlsh,sizeof(stcFlshRec) - 2); 
   \   0000012C   0x217E             MOVS     R1,#+126
   \   0000012E   0x4640             MOV      R0,R8
   \   00000130   0x.... 0x....      BL       GetCrc16Check
   \   00000134   0xF8A4 0x017E      STRH     R0,[R4, #+382]
    191              
    192          //	数据存储到flash    
    193              if(!WriteFlsh(FlshAddr, (uint8 *)&Ctrl.sRec, sizeof(Ctrl.sRec)))
   \   00000138   0x2280             MOVS     R2,#+128
   \   0000013A   0x4641             MOV      R1,R8
   \   0000013C   0x4638             MOV      R0,R7
   \   0000013E   0x.... 0x....      BL       WriteFlsh
    194              {}
    195              
    196              // 	保存数据记录号
    197              Ctrl.Para.dat.sRecNumMgr.Current++;
   \   00000142   0x6828             LDR      R0,[R5, #+0]
   \   00000144   0x1C40             ADDS     R0,R0,#+1
   \   00000146   0x6028             STR      R0,[R5, #+0]
    198          	FRAM_StoreRecNumMgr((stcRecNumMgr  *)&Ctrl.Para.dat.sRecNumMgr);    //数据记录号加1，并保存
   \   00000148   0x4628             MOV      R0,R5
   \   0000014A   0x.... 0x....      BL       FRAM_StoreRecNumMgr
    199              
    200              //调试
    201              FRAM_ReadRecNumMgr((stcRecNumMgr  *)&Ctrl.Para.dat.sRecNumMgr);         //读记录号
   \   0000014E   0x4628             MOV      R0,R5
   \   00000150   0x.... 0x....      BL       FRAM_ReadRecNumMgr
    202          
    203              ReadFlsh(FlshAddr, (uint8 *)&Ctrl.sRec, sizeof(Ctrl.sRec));
   \   00000154   0x2280             MOVS     R2,#+128
   \   00000156   0x4641             MOV      R1,R8
   \   00000158   0x4638             MOV      R0,R7
   \   0000015A   0x.... 0x....      BL       ReadFlsh
    204          }
   \   0000015E   0xE8BD 0x81F3      POP      {R0,R1,R4-R8,PC}  ;; return
    205          
    206          /*******************************************************************************
    207           * 名    称： 		ReadFlshRec
    208           * 功    能： 		根据记录号，取数据记录
    209           * 入口参数： 	    无
    210           * 出口参数： 	    无
    211           * 作　 　者： 	    redmornigcn
    212           * 创建日期： 	    2017-05-15
    213           * 修    改：
    214           * 修改日期：
    215           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    216          uint8	ReadFlshRec(stcFlshRec * sFlshRec,uint32	FlshRecNum)
    217          {
   \                     ReadFlshRec: (+1)
   \   00000000   0xB510             PUSH     {R4,LR}
   \   00000002   0x4604             MOV      R4,R0
   \   00000004   0x4608             MOV      R0,R1
    218          	uint32		FlshAddr;
    219          	
    220          	FlshAddr = GetRecNumAddr( FlshRecNum );						
   \   00000006   0x.... 0x....      BL       GetRecNumAddr
    221          	
    222          	if(ReadFlsh(FlshAddr,(uint8 *)sFlshRec,sizeof(stcFlshRec)))
   \   0000000A   0x2280             MOVS     R2,#+128
   \   0000000C   0x4621             MOV      R1,R4
   \   0000000E   0x.... 0x....      BL       ReadFlsh
   \   00000012   0x1E40             SUBS     R0,R0,#+1
   \   00000014   0x4180             SBCS     R0,R0,R0
   \   00000016   0x43C0             MVNS     R0,R0
   \   00000018   0x0FC0             LSRS     R0,R0,#+31
    223          	{
    224          		return 1;
    225          	}
    226          	
    227          	return	0;
   \   0000001A   0xBD10             POP      {R4,PC}          ;; return
    228          }
    229          
    230          /*******************************************************************************
    231           * 名    称：  TaskInitStore
    232           * 功    能：  任务初始化
    233           * 入口参数： 	无
    234           * 出口参数： 	无
    235           * 作　 　者： 	redmornigcn
    236           * 创建日期： 	2017-05-15
    237           * 修    改：
    238           * 修改日期：
    239           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    240          void    BSP_StoreInit(void)
    241          {
   \                     BSP_StoreInit: (+1)
   \   00000000   0xB538             PUSH     {R3-R5,LR}
    242              uint16 crc16;
    243              
    244          	InitFlashIO();              //初始化flash
   \   00000002   0x.... 0x....      BL       InitFlashIO
    245              //SPI_FLASH_Init();         //初始化flash
    246              JudgeFlashIDErrFlg();       //flash测试
   \   00000006   0x.... 0x....      BL       JudgeFlashIDErrFlg
    247              
    248              GPIO_Fram_Init();           //初始化fram
   \   0000000A   0x.... 0x....      BL       GPIO_Fram_Init
    249              
    250              InitDS3231();               //初始化时钟
   \   0000000E   0x.... 0x....      BL       InitDS3231
    251              
    252              OSRegWdtFlag( WDT_FLAG_STORE );
   \   00000012   0x2020             MOVS     R0,#+32
   \   00000014   0x.... 0x....      BL       OSRegWdtFlag
    253          
    254              //读Ctrl 
    255              FRAM_ReadRecNumMgr((stcRecNumMgr  *)&Ctrl.Para.dat.sRecNumMgr);         //读记录号
   \   00000018   0x....             LDR.N    R4,??DataTable2
   \   0000001A   0x1D20             ADDS     R0,R4,#+4
   \   0000001C   0x.... 0x....      BL       FRAM_ReadRecNumMgr
    256              FRAM_ReadProductInfo((stcProductInfo  *)&Ctrl.Para.dat.sProductInfo);   //读产品编号
   \   00000020   0xF104 0x0014      ADD      R0,R4,#+20
   \   00000024   0x.... 0x....      BL       FRAM_ReadProductInfo
    257              FRAM_ReadCurRecord((stcFlshRec  *)&Ctrl.sRec);                          //读当前记录
   \   00000028   0xF504 0x7080      ADD      R0,R4,#+256
   \   0000002C   0x.... 0x....      BL       FRAM_ReadCurRecord
    258              
    259              FRAM_ReadAirPara((stcAirPara  *)&Ctrl.Para.dat.sAirPara);               //读计算参数
   \   00000030   0xF104 0x0520      ADD      R5,R4,#+32
   \   00000034   0x4628             MOV      R0,R5
   \   00000036   0x.... 0x....      BL       FRAM_ReadAirPara
    260              
    261              crc16 = GetCrc16Check((uint8 *)&Ctrl.Para.dat.sAirPara,sizeof(stcAirPara) - 2); 
   \   0000003A   0x2126             MOVS     R1,#+38
   \   0000003C   0x4628             MOV      R0,R5
   \   0000003E   0x.... 0x....      BL       GetCrc16Check
    262              if(    Ctrl.Para.dat.sAirPara.crc16 != crc16
    263                 ||  (Ctrl.Para.dat.sAirPara.crc16  == 0 && Ctrl.Para.dat.sAirPara.sStandard_Hum.NormalLimit == 0)
    264                )
   \   00000042   0x8CE9             LDRH     R1,[R5, #+38]
   \   00000044   0x4281             CMP      R1,R0
   \   00000046   0xD104             BNE.N    ??BSP_StoreInit_0
   \   00000048   0x2900             CMP      R1,#+0
   \   0000004A   0xD113             BNE.N    ??BSP_StoreInit_1
   \   0000004C   0x8868             LDRH     R0,[R5, #+2]
   \   0000004E   0x2800             CMP      R0,#+0
   \   00000050   0xD110             BNE.N    ??BSP_StoreInit_1
    265              {
    266                  
    267                  Ctrl.Para.dat.sAirPara.sStandard_Dust.GoodLimit     = 200;
   \                     ??BSP_StoreInit_0: (+1)
   \   00000052   0x20C8             MOVS     R0,#+200
   \   00000054   0x8128             STRH     R0,[R5, #+8]
    268                  Ctrl.Para.dat.sAirPara.sStandard_Dust.NormalLimit   = 500;
   \   00000056   0xF44F 0x70FA      MOV      R0,#+500
   \   0000005A   0x8168             STRH     R0,[R5, #+10]
    269                  
    270                  Ctrl.Para.dat.sAirPara.sStandard_VOC.GoodLimit      = 500;
   \   0000005C   0x80A8             STRH     R0,[R5, #+4]
    271                  Ctrl.Para.dat.sAirPara.sStandard_VOC.NormalLimit    = 2000;
   \   0000005E   0xF44F 0x60FA      MOV      R0,#+2000
   \   00000062   0x80E8             STRH     R0,[R5, #+6]
    272                  
    273                  Ctrl.Para.dat.sAirPara.sStandard_Hum.GoodLimit      = 60;
   \   00000064   0x203C             MOVS     R0,#+60
   \   00000066   0x8028             STRH     R0,[R5, #+0]
    274                  Ctrl.Para.dat.sAirPara.sStandard_Hum.NormalLimit    = 85;
   \   00000068   0x2055             MOVS     R0,#+85
   \   0000006A   0x8068             STRH     R0,[R5, #+2]
    275                  
    276                  Ctrl.Para.dat.sAirPara.Dust_modefy  = 0;
   \   0000006C   0x2000             MOVS     R0,#+0
   \   0000006E   0x8228             STRH     R0,[R5, #+16]
    277                  Ctrl.Para.dat.sAirPara.Hum_modefy   = 0;
   \   00000070   0x81E8             STRH     R0,[R5, #+14]
    278                  Ctrl.Para.dat.sAirPara.Voc_modefy   = 0;
   \   00000072   0x8268             STRH     R0,[R5, #+18]
    279              }
    280              
    281              
    282              FRAM_ReadRunPara((stcRunPara  *)&Ctrl.Para.dat.sRunPara);               //读运行参数
   \                     ??BSP_StoreInit_1: (+1)
   \   00000074   0xF104 0x0048      ADD      R0,R4,#+72
   \   00000078   0xE8BD 0x4032      POP      {R1,R4,R5,LR}
   \   0000007C   0x.... 0x....      B.W      FRAM_ReadRunPara
    283              
    284          }
    285          
    286          /*******************************************************************************
    287           * 名    称：  TaskInitStore
    288           * 功    能：  任务初始化
    289           * 入口参数： 	无
    290           * 出口参数： 	无
    291           * 作　 　者： 	redmornigcn
    292           * 创建日期： 	2017-05-15
    293           * 修    改：
    294           * 修改日期：
    295           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    296          void TaskInitStore(void)
    297          {    
   \                     TaskInitStore: (+1)
   \   00000000   0xB580             PUSH     {R7,LR}
    298          //    /***********************************************
    299          //    * 描述： 初始化本任务用到的相关硬件
    300          //    */
    301              
    302              BSP_StoreInit();			                                //初始化Flash底层相关函数
   \   00000002   0x.... 0x....      BL       BSP_StoreInit
    303          
    304          //初始化定时器
    305              osal_start_timerEx( OS_TASK_ID_STORE,
    306                                  OS_EVT_STORE_TICKS,
    307                                  60*1000);                                 //60秒后再存储
   \   00000006   0xF64E 0x2260      MOVW     R2,#+60000
   \   0000000A   0x2101             MOVS     R1,#+1
   \   0000000C   0x2004             MOVS     R0,#+4
   \   0000000E   0xE8BD 0x4008      POP      {R3,LR}
   \   00000012   0x.... 0x....      B.W      osal_start_timerEx
    308          }
    309          
    310          extern  MODBUS_CH   *g_pch; 
    311          /*******************************************************************************
    312           * 名    称： 		AppTaskStore
    313           * 功    能： 		控制任务
    314           * 入口参数： 	p_arg - 由任务创建函数传入
    315           * 出口参数： 	无
    316           * 作　 　者： 	redmorningcn.
    317           * 创建日期： 	2017-05-15
    318           * 修    改：
    319           * 修改日期：
    320           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    321          osalEvt  TaskStoreEvtProcess(osalTid task_id, osalEvt task_event)
    322          {
   \                     TaskStoreEvtProcess: (+1)
   \   00000000   0xB510             PUSH     {R4,LR}
   \   00000002   0x460C             MOV      R4,R1
    323                  
    324              OSSetWdtFlag( WDT_FLAG_LED );
   \   00000004   0x2010             MOVS     R0,#+16
   \   00000006   0x.... 0x....      BL       OSSetWdtFlag
    325          
    326              if( task_event & OS_EVT_STORE_TICKS ) {
   \   0000000A   0x07E0             LSLS     R0,R4,#+31
   \   0000000C   0xD518             BPL.N    ??TaskStoreEvtProcess_0
    327          
    328                  StoreData();            //保存数据记录
   \   0000000E   0x.... 0x....      BL       StoreData
    329                  
    330                  if( Ctrl.Para.dat.sRunPara.MeasureMin < 1 || 
    331                      Ctrl.Para.dat.sRunPara.MeasureMin > 30  
    332                     )
   \   00000012   0x....             LDR.N    R0,??DataTable2
   \   00000014   0xF890 0x1051      LDRB     R1,[R0, #+81]
   \   00000018   0x2900             CMP      R1,#+0
   \   0000001A   0xD001             BEQ.N    ??TaskStoreEvtProcess_1
   \   0000001C   0x291F             CMP      R1,#+31
   \   0000001E   0xDB02             BLT.N    ??TaskStoreEvtProcess_2
    333                  {
    334                      Ctrl.Para.dat.sRunPara.MeasureMin = 2;
   \                     ??TaskStoreEvtProcess_1: (+1)
   \   00000020   0x2102             MOVS     R1,#+2
   \   00000022   0xF880 0x1051      STRB     R1,[R0, #+81]
    335                  }
    336                  
    337                  osal_start_timerEx( OS_TASK_ID_STORE,
    338                                OS_EVT_STORE_TICKS,
    339                                Ctrl.Para.dat.sRunPara.MeasureMin*60*1000);   
   \                     ??TaskStoreEvtProcess_2: (+1)
   \   00000026   0xF890 0x0051      LDRB     R0,[R0, #+81]
   \   0000002A   0xF64E 0x2160      MOVW     R1,#+60000
   \   0000002E   0xFB01 0xF200      MUL      R2,R1,R0
   \   00000032   0x2101             MOVS     R1,#+1
   \   00000034   0x2004             MOVS     R0,#+4
   \   00000036   0x.... 0x....      BL       osal_start_timerEx
    340                                      //1000);
    341                  return ( task_event ^ OS_EVT_STORE_TICKS );
   \   0000003A   0xF084 0x0001      EOR      R0,R4,#0x1
   \   0000003E   0xBD10             POP      {R4,PC}
    342              }
    343              
    344              return  task_event;
   \                     ??TaskStoreEvtProcess_0: (+1)
   \   00000040   0x4620             MOV      R0,R4
   \   00000042   0xBD10             POP      {R4,PC}          ;; return
    345          }

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2:
   \   00000000   0x........         DC32     Ctrl
    346          
    347          
    348          
    349          /*******************************************************************************
    350           * 				                    end of file                                *
    351           *******************************************************************************/
    352          #endif

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
      16   BSP_StoreInit
        16   -> FRAM_ReadAirPara
        16   -> FRAM_ReadCurRecord
        16   -> FRAM_ReadProductInfo
        16   -> FRAM_ReadRecNumMgr
         0   -> FRAM_ReadRunPara
        16   -> GPIO_Fram_Init
        16   -> GetCrc16Check
        16   -> InitDS3231
        16   -> InitFlashIO
        16   -> JudgeFlashIDErrFlg
        16   -> OSRegWdtFlag
       0   GetRecNumAddr
       8   ReadFlshRec
         8   -> GetRecNumAddr
         8   -> ReadFlsh
      32   StoreData
        32   -> FRAM_ReadRecNumMgr
        32   -> FRAM_StoreRecNumMgr
        32   -> GetCrc16Check
        32   -> GetRecNumAddr
        32   -> ReadFlsh
        32   -> ReadTime
        32   -> WriteFlsh
        32   -> __aeabi_memcpy
        32   -> __aeabi_memset
       8   TaskInitStore
         8   -> BSP_StoreInit
         0   -> osal_start_timerEx
       8   TaskStoreEvtProcess
         8   -> OSSetWdtFlag
         8   -> StoreData
         8   -> osal_start_timerEx


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable2
     128  BSP_StoreInit
       8  GetRecNumAddr
      28  ReadFlshRec
     354  StoreData
      22  TaskInitStore
      68  TaskStoreEvtProcess

 
 612 bytes in section .text
 
 612 bytes of CODE memory

Errors: none
Warnings: none
