###############################################################################
#
# IAR ANSI C/C++ Compiler V7.50.1.10123/W32 for ARM       30/Nov/2017  10:06:11
# Copyright 1999-2015 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  F:\iar\NC199B-100\Library\Source\BSP\Driver\bsp_wdt.c
#    Command line =  
#        F:\iar\NC199B-100\Library\Source\BSP\Driver\bsp_wdt.c -D
#        USE_STDPERIPH_DRIVER -D _STM32F10X_HD -D STM32F10X_CL -D DEBUG -D
#        STM32F103RC -D STM32_FLASH_SIZE=256 -D HSE_VALUE=25000000 -lCN
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-RC\List\
#        -o
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-RC\Obj\
#        --no_unroll --no_inline --no_tbaa --no_scheduling --debug
#        --endian=little --cpu=Cortex-M3 -e --fpu=None --dlib_config
#        "C:\Program Files (x86)\IAR Systems\Embedded Workbench
#        7.3\arm\INC\c\DLib_Config_Full.h" -I
#        F:\iar\NC199B-100\Library\Project\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\AES\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Config\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Port\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\OS\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Config\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Protocol\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Iap\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Driver\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\uCOS-III\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\CoreSupport\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\DeviceSupport\ST\STM32F10x\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\STM32F10x_StdPeriph_Driver\inc\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\ARM-Cortex-M3\IAR\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-LIB\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\OSAL\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\OSAL\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Cfg\Template\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\OS\uCOS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Ports\ARM-Cortex-M3\Generic\IAR\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Source\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\option\ -Om
#        --use_c++_inline -I "C:\Program Files (x86)\IAR Systems\Embedded
#        Workbench 7.3\arm\CMSIS\Include\"
#    List file    =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-RC\List\bsp_wdt.lst
#    Object file  =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-RC\Obj\bsp_wdt.o
#
###############################################################################

F:\iar\NC199B-100\Library\Source\BSP\Driver\bsp_wdt.c
      1          /*******************************************************************************
      2           *   Filename:       bsp_wdt.c
      3           *   Revised:        All copyrights reserved to Roger.
      4           *   Date:           2015-08-11
      5           *   Revision:       v1.0
      6           *   Writer:	     wumingshen.
      7           *
      8           *   Description:    看门狗驱动模块
      9           *
     10           *
     11           *   Notes:
     12           *   独立看门狗工作原理：在键值寄存器（IWDG_KR）中写入0XCCCC，开始启用独立看门狗，
     13           *   此时计数器开始从其复位值OXFFF递减计数，当计数器计数到末尾0X000的时候，会产生
     14           *   一个复位信号（IWDG_RESET），无论何时，只要寄存器IWDG_KR中被写入0XAAAA，IWDG_RLR
     15           *   中的值就会被重新加载到计数器中从而避免产生看门狗复位。
     16           *
     17           *   All copyrights reserved to wumingshen
     18           *******************************************************************************/
     19          
     20          /*******************************************************************************
     21          * INCLUDES
     22          */
     23          #include <includes.h>
     24          #include <bsp_wdt.h>
     25          
     26          #define BSP_WDT_MODULE_EN 1
     27          #if BSP_WDT_MODULE_EN > 0
     28          
     29          // 0:禁止；1：外部看门狗；2：内部看门狗；3：同时使用内部和外部看门狗;

   \                                 In section .data, align 1
     30          INT08U BSP_WdtMode  = 2;
   \                     BSP_WdtMode:
   \   00000000   0x02               DC8 2
     31          
     32          /*******************************************************************************
     33          * 名    称： BSP_WdtRst
     34          * 功    能： 喂狗
     35          * 入口参数： 无
     36          * 出口参数： 无
     37          * 作　 　者： 无名沈
     38          * 创建日期： 2014-08-18
     39          * 修    改：
     40          * 修改日期：
     41          * 备    注：
     42          *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
     43          void  BSP_WDT_Rst(void)
     44          {
   \                     BSP_WDT_Rst: (+1)
   \   00000000   0xB538             PUSH     {R3-R5,LR}
     45              if ( BSP_WdtMode == BSP_WDT_MODE_NONE )
   \   00000002   0x....             LDR.N    R4,??DataTable2
   \   00000004   0x7820             LDRB     R0,[R4, #+0]
   \   00000006   0x2800             CMP      R0,#+0
   \   00000008   0xD045             BEQ.N    ??BSP_WDT_Rst_0
     46                  return;
     47          #if OS_CRITICAL_METHOD == 3u                     /* Allocate storage for CPU status register           */
     48              OS_CPU_SR  cpu_sr = 0u;
     49          #endif
     50              /***********************************************
     51              * 描述：STM内部看门狗喂狗 Reload IWDG counter
     52              */
     53              if ( ( BSP_WdtMode == BSP_WDT_MODE_INT ) || ( BSP_WdtMode == BSP_WDT_MODE_ALL ) ) {
   \   0000000A   0x2802             CMP      R0,#+2
   \   0000000C   0xD001             BEQ.N    ??BSP_WDT_Rst_1
   \   0000000E   0x2803             CMP      R0,#+3
   \   00000010   0xD101             BNE.N    ??BSP_WDT_Rst_2
     54                  IWDG_ReloadCounter();
   \                     ??BSP_WDT_Rst_1: (+1)
   \   00000012   0x.... 0x....      BL       IWDG_ReloadCounter
   \                     ??BSP_WDT_Rst_2: (+1)
   \   00000016   0x7820             LDRB     R0,[R4, #+0]
   \   00000018   0x2801             CMP      R0,#+1
   \   0000001A   0xD001             BEQ.N    ??BSP_WDT_Rst_3
   \   0000001C   0x2803             CMP      R0,#+3
   \   0000001E   0xD13A             BNE.N    ??BSP_WDT_Rst_0
     55              }
     56              /***********************************************
     57              * 描述：外部看门狗喂狗
     58              */
     59              if ( ( BSP_WdtMode == BSP_WDT_MODE_EXT ) || ( BSP_WdtMode == BSP_WDT_MODE_ALL ) ) {
     60                  CPU_SR_ALLOC();
     61                  OS_CRITICAL_ENTER();
   \                     ??BSP_WDT_Rst_3: (+1)
   \   00000020   0x.... 0x....      BL       CPU_SR_Save
   \   00000024   0x4604             MOV      R4,R0
   \   00000026   0x.... 0x....      BL       CPU_IntDisMeasStart
   \   0000002A   0x....             LDR.N    R5,??DataTable2_1
   \   0000002C   0x7828             LDRB     R0,[R5, #+0]
   \   0000002E   0x1C40             ADDS     R0,R0,#+1
   \   00000030   0x7028             STRB     R0,[R5, #+0]
   \   00000032   0x.... 0x....      BL       CPU_IntDisMeasStop
   \   00000036   0x4620             MOV      R0,R4
   \   00000038   0x.... 0x....      BL       CPU_SR_Restore
     62                  GPIO_SetBits(WDI_GPIO_PORT, WDI_GPIO_PIN); 
   \   0000003C   0x....             LDR.N    R4,??DataTable2_2  ;; 0x40010800
   \   0000003E   0xF44F 0x7180      MOV      R1,#+256
   \   00000042   0x4620             MOV      R0,R4
   \   00000044   0x.... 0x....      BL       GPIO_SetBits
     63                  Delay_Nus(5);
   \   00000048   0x2005             MOVS     R0,#+5
   \   0000004A   0x.... 0x....      BL       Delay_Nus
     64                  GPIO_ResetBits(WDI_GPIO_PORT, WDI_GPIO_PIN);
   \   0000004E   0xF44F 0x7180      MOV      R1,#+256
   \   00000052   0x4620             MOV      R0,R4
   \   00000054   0x.... 0x....      BL       GPIO_ResetBits
     65                  OS_CRITICAL_EXIT();
   \   00000058   0x.... 0x....      BL       CPU_SR_Save
   \   0000005C   0x4604             MOV      R4,R0
   \   0000005E   0x.... 0x....      BL       CPU_IntDisMeasStart
   \   00000062   0x7828             LDRB     R0,[R5, #+0]
   \   00000064   0x1E40             SUBS     R0,R0,#+1
   \   00000066   0x7028             STRB     R0,[R5, #+0]
   \   00000068   0xB2C0             UXTB     R0,R0
   \   0000006A   0x2800             CMP      R0,#+0
   \   0000006C   0xD10C             BNE.N    ??BSP_WDT_Rst_4
   \   0000006E   0x....             LDR.N    R0,??DataTable2_3
   \   00000070   0x8800             LDRH     R0,[R0, #+0]
   \   00000072   0x2800             CMP      R0,#+0
   \   00000074   0xD008             BEQ.N    ??BSP_WDT_Rst_4
   \   00000076   0x.... 0x....      BL       CPU_IntDisMeasStop
   \   0000007A   0x4620             MOV      R0,R4
   \   0000007C   0x.... 0x....      BL       CPU_SR_Restore
   \   00000080   0xE8BD 0x4031      POP      {R0,R4,R5,LR}
   \   00000084   0x.... 0x....      B.W      OS_Sched0
   \                     ??BSP_WDT_Rst_4: (+1)
   \   00000088   0x.... 0x....      BL       CPU_IntDisMeasStop
   \   0000008C   0x4620             MOV      R0,R4
   \   0000008E   0xE8BD 0x4032      POP      {R1,R4,R5,LR}
   \   00000092   0x.... 0x....      B.W      CPU_SR_Restore
     66              }
     67          }
   \                     ??BSP_WDT_Rst_0: (+1)
   \   00000096   0xBD31             POP      {R0,R4,R5,PC}    ;; return
     68          
     69          /*******************************************************************************
     70          * 名    称： BSP_WDT_GetMode
     71          * 功    能： 获取用了什么看门狗
     72          * 入口参数： 无
     73          * 出口参数： 无
     74          * 作　 　者： 无名沈
     75          * 创建日期： 2014-08-18
     76          * 修    改：
     77          * 修改日期：
     78          * 备    注： （内部的？外部的？还是两个都用？）
     79          *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
     80          uint8_t  BSP_WDT_GetMode(void)
     81          {
     82              return BSP_WdtMode;
   \                     BSP_WDT_GetMode: (+1)
   \   00000000   0x....             LDR.N    R0,??DataTable2
   \   00000002   0x7800             LDRB     R0,[R0, #+0]
   \   00000004   0x4770             BX       LR               ;; return
     83          }
     84          
     85          /*******************************************************************************
     86          * 名    称： BSP_WDT_Init
     87          * 功    能： 独立看门狗初始化
     88          * 入口参数： 0:禁止；1：外部看门狗；2：内部看门狗；3：同时使用内部和外部看门狗;
     89          * 出口参数： 0：初始化成功 1：初始化失败
     90          * 作　 　者： 无名沈
     91          * 创建日期： 2014-08-18
     92          * 修    改：
     93          * 修改日期：
     94          * 备    注：
     95          *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
     96          uint8_t BSP_WDT_Init(uint8_t mode)
     97          {
   \                     BSP_WDT_Init: (+1)
   \   00000000   0xB510             PUSH     {R4,LR}
   \   00000002   0xB082             SUB      SP,SP,#+8
   \   00000004   0x0004             MOVS     R4,R0
     98              BSP_WdtMode = mode;
   \   00000006   0x....             LDR.N    R0,??DataTable2
   \   00000008   0x7004             STRB     R4,[R0, #+0]
     99          
    100              if ( mode == BSP_WDT_MODE_NONE )  //禁止狗
   \   0000000A   0xD101             BNE.N    ??BSP_WDT_Init_0
    101                  return 0;
   \   0000000C   0x2000             MOVS     R0,#+0
   \   0000000E   0xBD16             POP      {R1,R2,R4,PC}
    102          
    103              if ( ( mode == BSP_WDT_MODE_INT ) || ( mode == BSP_WDT_MODE_ALL ) ) { //使用内部狗或者内部外部狗一起用
   \                     ??BSP_WDT_Init_0: (+1)
   \   00000010   0x2C02             CMP      R4,#+2
   \   00000012   0xD001             BEQ.N    ??BSP_WDT_Init_1
   \   00000014   0x2C03             CMP      R4,#+3
   \   00000016   0xD11D             BNE.N    ??BSP_WDT_Init_2
    104          
    105                  /* Check if the system has resumed from IWDG reset */
    106                  if (RCC_GetFlagStatus(RCC_FLAG_IWDGRST) != RESET) {
   \                     ??BSP_WDT_Init_1: (+1)
   \   00000018   0x207D             MOVS     R0,#+125
   \   0000001A   0x.... 0x....      BL       RCC_GetFlagStatus
   \   0000001E   0x2800             CMP      R0,#+0
   \   00000020   0xD001             BEQ.N    ??BSP_WDT_Init_3
    107                      /* Clear reset flags */
    108                      RCC_ClearFlag();
   \   00000022   0x.... 0x....      BL       RCC_ClearFlag
    109                  } else {
    110                      /* IWDGRST flag is not set */
    111                  }
    112          
    113                  //2.独立看门狗(IWDG)由专用的40kHz 的低速时钟为驱动；因此，即使主时钟发生
    114                  //故障它也仍然有效。窗口看门狗由从APB1 时钟分频后得到的时钟驱动，通过可
    115                  //配置的时间窗口来检测应用程序非正常的过迟或过早的行为。可通过
    116                  //IWDG_SetPrescaler(IWDG_Prescaler_32); 对其时钟进行分频，4-256，
    117                  //通过以下方式喂狗 ：
    118                  ///* Reload IWDG counter */
    119                  //IWDG_ReloadCounter();
    120                  //3. 0.625KHz 即每周期 为1.6ms
    121                  //共计时 1000 个周期，即1000*1.6ms=1.6s
    122                  //看门狗定时时限= IWDG_SetReload（）的值 / 看门狗时钟频率
    123                  //看门狗时钟频率=LSI（内部低速时钟）的频率（40KHz）/ 分频数
    124          
    125                  RCC_LSICmd(ENABLE);                              //打开LSI
   \                     ??BSP_WDT_Init_3: (+1)
   \   00000026   0x2001             MOVS     R0,#+1
   \   00000028   0x.... 0x....      BL       RCC_LSICmd
    126                  while(RCC_GetFlagStatus(RCC_FLAG_LSIRDY)==RESET);
   \                     ??BSP_WDT_Init_4: (+1)
   \   0000002C   0x2061             MOVS     R0,#+97
   \   0000002E   0x.... 0x....      BL       RCC_GetFlagStatus
   \   00000032   0x2800             CMP      R0,#+0
   \   00000034   0xD0FA             BEQ.N    ??BSP_WDT_Init_4
    127          
    128                  /* Enable write access to IWDG_PR and IWDG_RLR registers */
    129                  IWDG_WriteAccessCmd(IWDG_WriteAccess_Enable);
   \   00000036   0xF245 0x5055      MOVW     R0,#+21845
   \   0000003A   0x.... 0x....      BL       IWDG_WriteAccessCmd
    130                  /* IWDG counter clock: 40KHz(LSI) / 64 * 2  = 0.625 / 2  KHz */
    131                  IWDG_SetPrescaler(IWDG_Prescaler_128);
   \   0000003E   0x2005             MOVS     R0,#+5
   \   00000040   0x.... 0x....      BL       IWDG_SetPrescaler
    132                  /* 3.2s ,max 0xFFF  0~4095  */
    133                  IWDG_SetReload(3000);
   \   00000044   0xF640 0x30B8      MOVW     R0,#+3000
   \   00000048   0x.... 0x....      BL       IWDG_SetReload
    134                  IWDG_ReloadCounter();
   \   0000004C   0x.... 0x....      BL       IWDG_ReloadCounter
    135                  IWDG_Enable();
   \   00000050   0x.... 0x....      BL       IWDG_Enable
    136              }
    137              if ( ( mode == BSP_WDT_MODE_EXT ) || ( mode == BSP_WDT_MODE_ALL ) ) { //使用外狗或者内狗外狗一起用
   \                     ??BSP_WDT_Init_2: (+1)
   \   00000054   0x2C01             CMP      R4,#+1
   \   00000056   0xD001             BEQ.N    ??BSP_WDT_Init_5
   \   00000058   0x2C03             CMP      R4,#+3
   \   0000005A   0xD111             BNE.N    ??BSP_WDT_Init_6
    138                  GPIO_InitTypeDef  gpio_init;
    139                  RCC_APB2PeriphClockCmd(WDI_GPIO_RCC, ENABLE);
   \                     ??BSP_WDT_Init_5: (+1)
   \   0000005C   0x2101             MOVS     R1,#+1
   \   0000005E   0x2004             MOVS     R0,#+4
   \   00000060   0x.... 0x....      BL       RCC_APB2PeriphClockCmd
    140          
    141                  gpio_init.GPIO_Pin   = WDI_GPIO_PIN;
   \   00000064   0xF44F 0x7080      MOV      R0,#+256
   \   00000068   0xF8AD 0x0000      STRH     R0,[SP, #+0]
    142                  gpio_init.GPIO_Speed = GPIO_Speed_50MHz;
   \   0000006C   0x2003             MOVS     R0,#+3
   \   0000006E   0xF88D 0x0002      STRB     R0,[SP, #+2]
    143                  gpio_init.GPIO_Mode  = GPIO_Mode_Out_PP;
   \   00000072   0x2010             MOVS     R0,#+16
   \   00000074   0xF88D 0x0003      STRB     R0,[SP, #+3]
    144          
    145                  GPIO_Init(WDI_GPIO_PORT, &gpio_init);
   \   00000078   0x4669             MOV      R1,SP
   \   0000007A   0x....             LDR.N    R0,??DataTable2_2  ;; 0x40010800
   \   0000007C   0x.... 0x....      BL       GPIO_Init
    146              }
    147          
    148              return 1;
   \                     ??BSP_WDT_Init_6: (+1)
   \   00000080   0x2001             MOVS     R0,#+1
   \   00000082   0xBD16             POP      {R1,R2,R4,PC}    ;; return
    149          }

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2:
   \   00000000   0x........         DC32     BSP_WdtMode

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2_1:
   \   00000000   0x........         DC32     OSSchedLockNestingCtr

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2_2:
   \   00000000   0x40010800         DC32     0x40010800

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable2_3:
   \   00000000   0x........         DC32     OSIntQNbrEntries
    150          
    151          /*******************************************************************************
    152          *              end of file                                                    *
    153          *******************************************************************************/
    154          #endif

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       0   BSP_WDT_GetMode
      16   BSP_WDT_Init
        16   -> GPIO_Init
        16   -> IWDG_Enable
        16   -> IWDG_ReloadCounter
        16   -> IWDG_SetPrescaler
        16   -> IWDG_SetReload
        16   -> IWDG_WriteAccessCmd
        16   -> RCC_APB2PeriphClockCmd
        16   -> RCC_ClearFlag
        16   -> RCC_GetFlagStatus
        16   -> RCC_LSICmd
      16   BSP_WDT_Rst
        16   -> CPU_IntDisMeasStart
        16   -> CPU_IntDisMeasStop
         0   -> CPU_SR_Restore
        16   -> CPU_SR_Restore
        16   -> CPU_SR_Save
        16   -> Delay_Nus
        16   -> GPIO_ResetBits
        16   -> GPIO_SetBits
        16   -> IWDG_ReloadCounter
         0   -> OS_Sched0


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable2
       4  ??DataTable2_1
       4  ??DataTable2_2
       4  ??DataTable2_3
       6  BSP_WDT_GetMode
     132  BSP_WDT_Init
     152  BSP_WDT_Rst
       1  BSP_WdtMode

 
   1 byte  in section .data
 306 bytes in section .text
 
 306 bytes of CODE memory
   1 byte  of DATA memory

Errors: none
Warnings: none
