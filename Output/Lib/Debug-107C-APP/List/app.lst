###############################################################################
#
# IAR ANSI C/C++ Compiler V7.50.1.10123/W32 for ARM       26/Dec/2017  20:53:01
# Copyright 1999-2015 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  F:\iar\NC199B-100\Library\Source\APP\User\app.c
#    Command line =  
#        F:\iar\NC199B-100\Library\Source\APP\User\app.c -D
#        USE_STDPERIPH_DRIVER -D STM32F10X_CL -D DEBUG -D IMAGE_A -D
#        STM32F103RC -D STM32_FLASH_SIZE=256 -D HSE_VALUE=25000000 -lCN
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\List\
#        -o
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\Obj\
#        --no_unroll --no_inline --no_tbaa --no_scheduling --debug
#        --endian=little --cpu=Cortex-M3 -e --fpu=None --dlib_config
#        "C:\Program Files (x86)\IAR Systems\Embedded Workbench
#        7.3\arm\INC\c\DLib_Config_Full.h" -I
#        F:\iar\NC199B-100\Library\Project\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\AES\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Config\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\User\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Port\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\OS\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\SIM900A\Config\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Protocol\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\APP\Iap\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Driver\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\IAR\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\uCOS-III\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\CoreSupport\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\CMSIS\CM3\DeviceSupport\ST\STM32F10x\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\St\FWLib\STM32F10x_StdPeriph_Driver\inc\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-CPU\ARM-Cortex-M3\IAR\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-LIB\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\BSP\Os\OSAL\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\OSAL\OS\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Cfg\Template\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\OS\uCOS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-MB\Source\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Ports\ARM-Cortex-M3\Generic\IAR\
#        -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\Micrium\uC-OS-III\Source\
#        -I F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\ -I
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\Source\FatFs\option\ -Om
#        --use_c++_inline -I "C:\Program Files (x86)\IAR Systems\Embedded
#        Workbench 7.3\arm\CMSIS\Include\"
#    List file    =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\List\app.lst
#    Object file  =  
#        F:\iar\NC199B-100\Library\Project\IAR\..\..\..\Output\Lib\Debug-107C-APP\Obj\app.o
#
###############################################################################

F:\iar\NC199B-100\Library\Source\APP\User\app.c
      1          /*******************************************************************************
      2           *   Filename:      app.c
      3           *   Revised:       $Date: 2013-06-30$
      4           *   Revision:      $
      5           *	 Writer:		Wuming Shen.
      6           *
      7           *   Description:
      8           *   Notes:
      9           *					QQ:276193028
     10           *     				E-mail:shenchangwei945@163.com
     11           *
     12           *   All copyrights reserved to Wuming Shen.
     13           *
     14           *******************************************************************************/
     15          
     16          /*******************************************************************************
     17           * INCLUDES
     18           */
     19          #define  SNL_APP_SOURCE
     20          #include <app.h>
     21          #include <includes.h>
     22          //#include <iap.h>
     23          
     24          #ifdef VSC_INCLUDE_SOURCE_FILE_NAMES
     25          const  CPU_CHAR  *app__c = "$Id: $";
     26          #endif
     27          
     28          /*******************************************************************************
     29           * CONSTANTS
     30           */
     31          /****************************************************
     32          * 描述： 喂狗主任务的执行周期（单位:MS）
     33          */
     34          #define CYCLE_TIME_TICKS            (OS_CFG_TICK_RATE_HZ)
     35          
     36          //#define DEBUG_SIM                   DEF_ENABLED    // 软件仿真开关
     37          /*******************************************************************************
     38           * MACROS
     39           */
     40          
     41          /*******************************************************************************
     42           * TYPEDEFS
     43           */
     44          
     45          /*******************************************************************************
     46           * LOCAL VARIABLES
     47           */
     48          /***************************************************
     49          * 描述： uC/OS-III 任务控制块（TCB）
     50          *
     51          *       类型        TCB名称
     52          */

   \                                 In section .bss, align 4
     53          static  OS_TCB      AppTaskStartTCB;
   \                     AppTaskStartTCB:
   \   00000000                      DS8 184
   \   000000B8                      DS8 256
     54          
     55          /***************************************************
     56          * 描述： uC/OS 任务控制块（STACKS）
     57          *
     58          *       类型        堆栈名称                堆栈大小
     59          */
     60          static  CPU_STK     AppTaskStartStk         [ APP_TASK_START_STK_SIZE ];
     61          
     62          /***********************************************
     63          * 描述： 创建标志组
     64          */

   \                                 In section .bss, align 4
     65          OS_FLAG_GRP         WdtFlagGRP;                     //看门狗标志组
     66          OS_FLAGS            WdtFlags;
   \                     WdtFlags:
   \   00000000                      DS8 4
   \                     WdtFlagGRP:
   \   00000004                      DS8 28
     67          
     68          /***************************************************
     69          * 描述： 软定时器声明
     70          */

   \                                 In section .bss, align 4
     71          OS_TMR              OSTmr0;                         // 定时器1
   \                     OSTmr0:
   \   00000000                      DS8 44
     72          /****************************************************
     73          * 描述： 超过WdtTimeoutSec的时间还没有喂狗，系统复位。
     74          *        单位为 秒（S）
     75          */
     76          #define             WdtTimeoutSec           60
     77          
     78          /*******************************************************************************
     79           * GLOBAL VARIABLES
     80           */
     81          
     82          /*******************************************************************************
     83           * LOCAL FUNCTIONS
     84           *
     85           * 返回类型         函数名称                入口参数
     86           */
     87          static  void        AppTaskCreate           (void);
     88          static  void        AppObjCreate            (void);
     89          /***********************************************
     90          * 描述： 函数申明
     91          */
     92          //static  void        App_Init                (void);
     93          static  void        AppTaskStart            (void *p_arg);
     94          /***********************************************
     95          * 描述： 软定时器回调函数
     96          */
     97          void                OSTmr0_callback         (OS_TMR *ptmr,void *p_arg);
     98          
     99          /*******************************************************************************
    100           * GLOBAL FUNCTIONS
    101           */
    102          
    103          /*******************************************************************************
    104           * EXTERN VARIABLES
    105           */
    106          
    107          /*******************************************************************************
    108           * EXTERN FUNCTIONS
    109           */
    110          extern  void        APP_TempEventProcess    (void);
    111          extern  void        App_InitStartHook       (void);
    112          extern  void        App_InitEndHook         (void);
    113          extern  void        AppTaskStart            (void *p_arg);
    114          extern  void        App_Main                (void);
    115          
    116          /*******************************************************************************
    117           * @fn      &:main
    118           * @brief   &:First function called after startup.
    119           * @return  &:don't care
    120           ******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    121          int main (void)
    122          {
   \                     main: (+1)
   \   00000000   0xB500             PUSH     {LR}
   \   00000002   0xB08B             SUB      SP,SP,#+44
    123              OS_ERR  err;
    124          
    125              /***********************************************
    126              * 描述： 第一个调用函数，可以不返回
    127              */
    128              App_Main();
   \   00000004   0x.... 0x....      BL       App_Main
    129          //    
    130          //    ////20171128
    131          //    BSP_Init();
    132              
    133          #if DEBUG_SIM != DEF_ENABLED
    134          //#if !defined (LIBRARY)
    135              /***********************************************
    136              * 描述： 仅限64K芯片可用，其他容量芯片不让使用
    137              */
    138              INT16U FlashSize    = *(INT16U*)(0x1FFFF7E0);  // 闪存容量寄存器   
    139              if ( FlashSize != STM32_FLASH_SIZE )           // STM32F103RC  256K，在option中定义
   \   00000008   0x....             LDR.N    R0,??DataTable6  ;; 0x1ffff7e0
   \   0000000A   0x8800             LDRH     R0,[R0, #+0]
   \   0000000C   0xF5B0 0x7F80      CMP      R0,#+256
   \   00000010   0xD000             BEQ.N    ??main_0
    140                  while(1);
   \                     ??main_1: (+1)
   \   00000012   0xE7FE             B.N      ??main_1
    141          //#endif
    142          #endif
    143              /***********************************************
    144              * 描述： Init uC/OS-III.
    145              */
    146              OSInit(&err);
   \                     ??main_0: (+1)
   \   00000014   0xA809             ADD      R0,SP,#+36
   \   00000016   0x.... 0x....      BL       OSInit
    147          
    148              /***********************************************
    149              * 描述： 创建起始任务
    150              */
    151              OSTaskCreate((OS_TCB     *)&AppTaskStartTCB,                // 任务控制块（当前文件中定义）
    152                           (CPU_CHAR   *)"App Task Start",                // 任务名称
    153                           (OS_TASK_PTR ) AppTaskStart,                   // 任务函数指针（当前文件中定义）
    154                           (void       *) 0,                              // 任务函数参数
    155                           (OS_PRIO     ) APP_TASK_START_PRIO,            // 任务优先级，不同任务优先级可以相同，0 < 优先级 < OS_CFG_PRIO_MAX - 2（app_cfg.h中定义）
    156                           (CPU_STK    *)&AppTaskStartStk[0],             // 任务栈顶
    157                           (CPU_STK_SIZE) APP_TASK_START_STK_SIZE / 10,   // 任务栈溢出报警值
    158                           (CPU_STK_SIZE) APP_TASK_START_STK_SIZE,        // 任务栈大小（CPU数据宽度 * 8 * size = 4 * 8 * size(字节)）（app_cfg.h中定义）
    159                           (OS_MSG_QTY  ) 0u,                             // 可以发送给任务的最大消息队列数量
    160                           (OS_TICK     ) 0u,                             // 相同优先级任务的轮循时间（ms），0为默认
    161                           (void       *) 0,                              // 是一个指向它被用作一个TCB扩展用户提供的存储器位置
    162                           (OS_OPT      )(OS_OPT_TASK_STK_CHK |           // 允许堆栈检查该任务
    163                                          OS_OPT_TASK_STK_CLR),           // 创建任务时堆栈清零
    164                           (OS_ERR     *)&err);                           // 指向错误代码的指针，用于创建结果处理
   \   0000001A   0x....             LDR.N    R0,??DataTable6_1
   \   0000001C   0xA909             ADD      R1,SP,#+36
   \   0000001E   0x9108             STR      R1,[SP, #+32]
   \   00000020   0x2103             MOVS     R1,#+3
   \   00000022   0x9107             STR      R1,[SP, #+28]
   \   00000024   0x2100             MOVS     R1,#+0
   \   00000026   0x9106             STR      R1,[SP, #+24]
   \   00000028   0x9105             STR      R1,[SP, #+20]
   \   0000002A   0x9104             STR      R1,[SP, #+16]
   \   0000002C   0x2140             MOVS     R1,#+64
   \   0000002E   0x9103             STR      R1,[SP, #+12]
   \   00000030   0x2106             MOVS     R1,#+6
   \   00000032   0x9102             STR      R1,[SP, #+8]
   \   00000034   0xF100 0x01B8      ADD      R1,R0,#+184
   \   00000038   0x9101             STR      R1,[SP, #+4]
   \   0000003A   0x2112             MOVS     R1,#+18
   \   0000003C   0x9100             STR      R1,[SP, #+0]
   \   0000003E   0x2300             MOVS     R3,#+0
   \   00000040   0x.... 0x....      ADR.W    R2,AppTaskStart
   \   00000044   0x.... 0x....      ADR.W    R1,?_0
   \   00000048   0x.... 0x....      BL       OSTaskCreate
    165          
    166            
    167              /***********************************************
    168              * 描述： 启动 uC/OS-III
    169              */
    170              //NVIC_SetVectorTable(NVIC_VectTab_FLASH, 0X10000);
    171              SCB->VTOR = (NVIC_VectTab_FLASH | 0X10000);
   \   0000004C   0x....             LDR.N    R0,??DataTable6_2  ;; 0x8010000
   \   0000004E   0x....             LDR.N    R1,??DataTable6_3  ;; 0xe000ed08
   \   00000050   0x6008             STR      R0,[R1, #+0]
    172                  
    173              OSStart(&err);
   \   00000052   0xA809             ADD      R0,SP,#+36
   \   00000054   0x.... 0x....      BL       OSStart
    174          }
   \   00000058   0x2000             MOVS     R0,#+0
   \   0000005A   0xB00B             ADD      SP,SP,#+44
   \   0000005C   0xBD00             POP      {PC}             ;; return
    175          
    176          /*
    177          ********************************************************************************
    178          *                                          STARTUP TASK
    179          *
    180          * Description : This is an example of a startup task.  As mentioned in the book's 
    181          *               text, you MUST initialize the ticker only once multitasking has started.
    182          *
    183          * Arguments   : p_arg   is the argument passed to 'AppTaskStart()' by 'OSTaskCreate()'.
    184          *
    185          * Returns     : none
    186          *
    187          * Notes       : 1) The first line of code is used to prevent a compiler warning 
    188          *               because 'p_arg' is not used.  The compiler should not generate 
    189          *               any code for this statement.
    190          ********************************************************************************
    191          */

   \                                 In section .text, align 4, keep-with-next
    192          static  void  AppTaskStart (void *p_arg)
    193          {
   \                     AppTaskStart: (+1)
   \   00000000   0xB570             PUSH     {R4-R6,LR}
   \   00000002   0xB084             SUB      SP,SP,#+16
    194              CPU_INT32U  cpu_clk_freq;
    195              CPU_INT32U  cnts;
    196              OS_ERR      err;
    197              INT32U      ticks;
    198              INT32S      dly;
    199              INT16U  	TimeOutCnt     = 0;                 //看门狗超时计数器
   \   00000004   0x2400             MOVS     R4,#+0
    200              uint8_t     ReadRTCTimeCnt = 0;
    201              (void)p_arg;
    202              
    203              
    204              //test_DM412_Led();
    205              
    206              /***********************************************
    207              * 描述： 设置STM32的系统时钟，I/O口设置，定时器等
    208              */
    209          #if DEBUG_SIM != DEF_ENABLED
    210              BSP_Init();                                                 /* Initialize BSP functions                             */
   \   00000006   0x.... 0x....      BL       BSP_Init
    211          #endif
    212              CPU_Init();
   \   0000000A   0x.... 0x....      BL       CPU_Init
    213              
    214              /***********************************************
    215              * 描述： 初始化滴答定时器，即初始化系统节拍时钟。
    216              */
    217              cpu_clk_freq = BSP_CPU_ClkFreq();                           /* Determine SysTick reference freq.                    */
   \   0000000E   0x.... 0x....      BL       BSP_CPU_ClkFreq
    218              cnts = cpu_clk_freq / (CPU_INT32U)OSCfg_TickRate_Hz;        /* Determine nbr SysTick increments                     */
    219              OS_CPU_SysTickInit(cnts);                                   /* Init uC/OS periodic time src (SysTick).              */
   \   00000012   0x....             LDR.N    R1,??DataTable6_4
   \   00000014   0x6809             LDR      R1,[R1, #+0]
   \   00000016   0xFBB0 0xF0F1      UDIV     R0,R0,R1
   \   0000001A   0x.... 0x....      BL       OS_CPU_SysTickInit
    220              
    221              /***********************************************
    222              * 描述： 设置UCOS钩子函数
    223              */
    224              App_OS_SetAllHooks();
   \   0000001E   0x.... 0x....      BL       App_OS_SetAllHooks
    225              
    226              /***********************************************
    227              * 描述： 初始化内存管理模块
    228              */
    229          #if (LIB_MEM_CFG_ALLOC_EN == DEF_ENABLED)
    230              Mem_Init();                                                 /* Initialize Memory Management Module                  */
    231          #endif
    232              
    233              /***********************************************
    234              * 描述： 看门狗初始化
    235              */
    236          #if DEBUG_SIM != DEF_ENABLED
    237          #if defined     (RELEASE)
    238              BSP_WDT_Init(BSP_WDT_MODE_ALL);
    239          #else
    240              BSP_WDT_Init(BSP_WDT_MODE_NONE);
   \   00000022   0x4620             MOV      R0,R4
   \   00000024   0x.... 0x....      BL       BSP_WDT_Init
    241          #endif  
    242          #endif
    243              
    244              WdtReset();
   \   00000028   0x.... 0x....      BL       BSP_WDT_Rst
    245              /***********************************************
    246              * 描述： E2PROM初始化
    247              */
    248          #if DEBUG_SIM != DEF_ENABLED
    249              //App_Init();
    250          #endif
    251              extern StrNcProtocol   ComPackCtrl[4];
    252              //    Ctrl.MtrPar     = &Mater;
    253              //    Ctrl.Com.pack   = &ComPackCtrl[0];
    254              //    Ctrl.Dtu.pack   = &ComPackCtrl[1];
    255              
    256              
    257              App_TaskCommCreate();
   \   0000002C   0x.... 0x....      BL       App_TaskCommCreate
    258              
    259              App_TaskMeasureCreate();
   \   00000030   0x.... 0x....      BL       App_TaskMeasureCreate
    260              /***********************************************
    261              * 描述： 喂狗
    262              */
    263              WdtReset();
   \   00000034   0x.... 0x....      BL       BSP_WDT_Rst
    264              
    265              /***********************************************
    266              * 描述： 估算在没有运行任务时CPU的能力
    267              */
    268          #if OS_CFG_STAT_TASK_EN > 0u
    269              OSStatTaskCPUUsageInit(&err);                               /* Compute CPU capacity with no task running            */
    270          #endif
    271              
    272              /***********************************************
    273              * 描述：用于测量禁止中断的时间
    274              */
    275              CPU_IntDisMeasMaxCurReset();
   \   00000038   0x.... 0x....      BL       CPU_IntDisMeasMaxCurReset
    276              
    277          #if (APP_CFG_SERIAL_EN == DEF_ENABLED)
    278              BSP_Ser_Init(115200);                                       /* Enable Serial Interface                              */
    279          #endif
    280              
    281              /***********************************************
    282              * 描述： 创建对象（事件）,标志组
    283              */
    284              AppObjCreate();                                             /* Create Application Objects                           */
   \   0000003C   0x.... 0x....      BL       AppObjCreate
    285              
    286              /***********************************************
    287              * 描述： 创建创建任务
    288              */
    289              AppTaskCreate();                                            /* Create Application Tasks                             */
   \   00000040   0x.... 0x....      BL       AppTaskCreate
   \   00000044   0x....             LDR.N    R6,??DataTable6_5
   \   00000046   0xE008             B.N      ??AppTaskStart_0
    290              
    291              //    Ctrl.Com.SlaveAddr     = 0xA3;
    292              /***************************************************************************
    293              * 描述：每一个任务在创建时分配了一个喂狗标志位
    294              *	    每个任务在执行过和中，在未超出看门狗超时时间内
    295              *	    将相应的标志位置位，该任务将每秒钟查询一次
    296              *	    已经注册到喂狗标志位组的标志位，如果当前标志
    297              *	    位与注册的标志位相等，则表示每个任务当前都处于
    298              *	    活动状态，此时将超时计数器清零，重新开始超时计数
    299              *	    如果喂狗标志位没有全部置位，则将超时计数器+1，当
    300              *	    计数值超出设定的计数值时，系统进行重启。
    301              */
    302              while (DEF_TRUE) {
    303                  /***********************************************
    304                  * 描述： 得到系统当前时间
    305                  */
    306                  ticks = OSTimeGet(&err);
    307                  ReadRTCTimeCnt  ++;
    308                  
    309                  /***********************************************
    310                  * 描述： 喂狗
    311                  */
    312                  WdtReset();
    313                  
    314                  /***********************************************************************
    315                  * 描述： 独立看门狗标志组检查， 判断是否所有任务已喂狗
    316                  */
    317                  OSFlagPend(( OS_FLAG_GRP *)&WdtFlagGRP,
    318                             ( OS_FLAGS     ) WdtFlags,
    319                             ( OS_TICK      ) 50,
    320                             ( OS_OPT       ) OS_OPT_PEND_FLAG_SET_ALL,   //全部置一
    321                             ( CPU_TS      *) NULL,
    322                             ( OS_ERR      *)&err);
    323                  
    324                  if(err == OS_ERR_NONE) {                                //所有任务已喂狗
    325                      TimeOutCnt = 0;                                     //超时计数器清零
    326                      //BSP_LED_Flash( 1, 1, 40, 40);
    327                      OS_FlagPost ((OS_FLAG_GRP *)&WdtFlagGRP,            //清零所有标志
    328                                   (OS_FLAGS     ) WdtFlags,
    329                                   (OS_OPT       ) OS_OPT_POST_FLAG_CLR,
    330                                   (CPU_TS       ) 0,
    331                                   (OS_ERR      *) &err);
    332                  } else {                                                //不是所有任务都喂狗
    333                      TimeOutCnt++;                                       //超时计数器加1
    334                      if(TimeOutCnt > WdtTimeoutSec) {                    //喂狗超时
    335                          /***********************************************
    336                          * 描述： 如果程序处在升级模式
    337                          */
    338          #if defined(RELASE)
    339                          SystemReset();							    //系统重启
    340          #else
    341                          while(1){
    342                              TimeOutCnt++;
    343                              /*******************************************************
    344                              * 描述： 长时间等不到某任务的看门狗标志位注册，说明有任务死了，
    345                              *        指示灯快速闪烁，进入死循环等待系统复位
    346                              */
    347                              //BSP_LED_Toggle(1);
    348                              Delay_Nms(100);
    349                              
    350          #define     RGB_LED_COLOR_RED       0xffff,0x0000,0x0000
    351          #define     RGB_LED_COLOR_GREEN     0x0000,0xffff,0x0000
    352          #define     RGB_LED_COLOR_BLUE      0x0000,0x0000,0xffff
    353          #define     RGB_LED_COLOR_WHITE     0xffff,0xffff,0xffff
    354                              
    355          #define     HUM_LED         0
    356          #define     DUST_LED        1
    357          #define     OIL_LED         2
    358                              /***********************************************
    359                              * 描述： 湿度显示
    360                              */
    361                              switch(TimeOutCnt%3)
    362                              {
    363                              case 0:
    364                                  SetLedColor(HUM_LED,RGB_LED_COLOR_BLUE); 
    365                                  SetLedColor(OIL_LED,RGB_LED_COLOR_BLUE); 
    366                                  SetLedColor(DUST_LED,RGB_LED_COLOR_BLUE);
    367                                  break;
    368                              case 1:
    369                                  SetLedColor(HUM_LED,RGB_LED_COLOR_GREEN);
    370                                  SetLedColor(OIL_LED,RGB_LED_COLOR_GREEN);
    371                                  SetLedColor(DUST_LED,RGB_LED_COLOR_GREEN);
    372                                  break;
    373                              case 2:
    374                                  SetLedColor(HUM_LED,RGB_LED_COLOR_RED); 
    375                                  SetLedColor(OIL_LED,RGB_LED_COLOR_RED); 
    376                                  SetLedColor(DUST_LED,RGB_LED_COLOR_RED);
    377                                  break;
    378                              default:       
    379                                  SetLedColor(HUM_LED,RGB_LED_COLOR_BLUE);
    380                                  SetLedColor(OIL_LED,RGB_LED_COLOR_BLUE); 
    381                                  SetLedColor(DUST_LED,RGB_LED_COLOR_BLUE);
    382                                  break;
    383                              }
    384                          }
    385          #endif
    386                      } else {
    387                          //BSP_LED_Flash( 1, 1, 500, 500); 
    388                      }
    389                  }
    390                  
    391                  /***********************************************
    392                  * 描述： 去除任务运行的时间，等到一个控制周期里剩余需要延时的时间
    393                  */
    394                  dly   = CYCLE_TIME_TICKS - ( OSTimeGet(&err) - ticks );
    395                  if ( dly  <= 0 ) {
    396                      dly   = 0;
    397                  }else if(dly > CYCLE_TIME_TICKS)
   \                     ??AppTaskStart_1: (+1)
   \   00000048   0xF5B0 0x7F7A      CMP      R0,#+1000
   \   0000004C   0xD901             BLS.N    ??AppTaskStart_2
    398                  {
    399                      dly   =  CYCLE_TIME_TICKS;
   \   0000004E   0xF44F 0x707A      MOV      R0,#+1000
    400                  }
    401                  OSTimeDly(dly, OS_OPT_TIME_DLY, &err);
   \                     ??AppTaskStart_2: (+1)
   \   00000052   0xAA02             ADD      R2,SP,#+8
   \   00000054   0x2100             MOVS     R1,#+0
   \   00000056   0x.... 0x....      BL       OSTimeDly
   \                     ??AppTaskStart_0: (+1)
   \   0000005A   0xA802             ADD      R0,SP,#+8
   \   0000005C   0x.... 0x....      BL       OSTimeGet
   \   00000060   0x4605             MOV      R5,R0
   \   00000062   0x.... 0x....      BL       BSP_WDT_Rst
   \   00000066   0xA802             ADD      R0,SP,#+8
   \   00000068   0x9001             STR      R0,[SP, #+4]
   \   0000006A   0x2000             MOVS     R0,#+0
   \   0000006C   0x9000             STR      R0,[SP, #+0]
   \   0000006E   0x2304             MOVS     R3,#+4
   \   00000070   0x2232             MOVS     R2,#+50
   \   00000072   0x6831             LDR      R1,[R6, #+0]
   \   00000074   0x1D30             ADDS     R0,R6,#+4
   \   00000076   0x.... 0x....      BL       OSFlagPend
   \   0000007A   0xF8BD 0x0008      LDRH     R0,[SP, #+8]
   \   0000007E   0x2800             CMP      R0,#+0
   \   00000080   0xD112             BNE.N    ??AppTaskStart_3
   \   00000082   0x2400             MOVS     R4,#+0
   \   00000084   0xA802             ADD      R0,SP,#+8
   \   00000086   0x9000             STR      R0,[SP, #+0]
   \   00000088   0x4623             MOV      R3,R4
   \   0000008A   0x2201             MOVS     R2,#+1
   \   0000008C   0x6831             LDR      R1,[R6, #+0]
   \   0000008E   0x1D30             ADDS     R0,R6,#+4
   \   00000090   0x.... 0x....      BL       OS_FlagPost
   \                     ??AppTaskStart_4: (+1)
   \   00000094   0xA802             ADD      R0,SP,#+8
   \   00000096   0x.... 0x....      BL       OSTimeGet
   \   0000009A   0xF5C0 0x707A      RSB      R0,R0,#+1000
   \   0000009E   0x1828             ADDS     R0,R5,R0
   \   000000A0   0x2801             CMP      R0,#+1
   \   000000A2   0xDAD1             BGE.N    ??AppTaskStart_1
   \   000000A4   0x2000             MOVS     R0,#+0
   \   000000A6   0xE7D4             B.N      ??AppTaskStart_2
   \                     ??AppTaskStart_3: (+1)
   \   000000A8   0x1C64             ADDS     R4,R4,#+1
   \   000000AA   0xB2A4             UXTH     R4,R4
   \   000000AC   0x2C3D             CMP      R4,#+61
   \   000000AE   0xDBF1             BLT.N    ??AppTaskStart_4
   \                     ??AppTaskStart_5: (+1)
   \   000000B0   0x1C64             ADDS     R4,R4,#+1
   \   000000B2   0x2064             MOVS     R0,#+100
   \   000000B4   0x.... 0x....      BL       Delay_Nms
   \   000000B8   0xB2A4             UXTH     R4,R4
   \   000000BA   0x2003             MOVS     R0,#+3
   \   000000BC   0xFB94 0xF0F0      SDIV     R0,R4,R0
   \   000000C0   0xEB00 0x0040      ADD      R0,R0,R0, LSL #+1
   \   000000C4   0x1A20             SUBS     R0,R4,R0
   \   000000C6   0x2801             CMP      R0,#+1
   \   000000C8   0xD002             BEQ.N    ??AppTaskStart_6
   \   000000CA   0x2802             CMP      R0,#+2
   \   000000CC   0xD015             BEQ.N    ??AppTaskStart_7
   \   000000CE   0xE029             B.N      ??AppTaskStart_8
   \                     ??AppTaskStart_6: (+1)
   \   000000D0   0xF64F 0x75FF      MOVW     R5,#+65535
   \   000000D4   0x2300             MOVS     R3,#+0
   \   000000D6   0x462A             MOV      R2,R5
   \   000000D8   0x4619             MOV      R1,R3
   \   000000DA   0x4608             MOV      R0,R1
   \   000000DC   0x.... 0x....      BL       SetLedColor
   \   000000E0   0x2300             MOVS     R3,#+0
   \   000000E2   0x462A             MOV      R2,R5
   \   000000E4   0x4619             MOV      R1,R3
   \   000000E6   0x2002             MOVS     R0,#+2
   \   000000E8   0x.... 0x....      BL       SetLedColor
   \   000000EC   0x2300             MOVS     R3,#+0
   \   000000EE   0x462A             MOV      R2,R5
   \   000000F0   0x4619             MOV      R1,R3
   \   000000F2   0x2001             MOVS     R0,#+1
   \   000000F4   0x.... 0x....      BL       SetLedColor
   \   000000F8   0xE7DA             B.N      ??AppTaskStart_5
   \                     ??AppTaskStart_7: (+1)
   \   000000FA   0xF64F 0x75FF      MOVW     R5,#+65535
   \   000000FE   0x2300             MOVS     R3,#+0
   \   00000100   0x461A             MOV      R2,R3
   \   00000102   0x4629             MOV      R1,R5
   \   00000104   0x4610             MOV      R0,R2
   \   00000106   0x.... 0x....      BL       SetLedColor
   \   0000010A   0x2300             MOVS     R3,#+0
   \   0000010C   0x461A             MOV      R2,R3
   \   0000010E   0x4629             MOV      R1,R5
   \   00000110   0x2002             MOVS     R0,#+2
   \   00000112   0x.... 0x....      BL       SetLedColor
   \   00000116   0x2300             MOVS     R3,#+0
   \   00000118   0x461A             MOV      R2,R3
   \   0000011A   0x4629             MOV      R1,R5
   \   0000011C   0x2001             MOVS     R0,#+1
   \   0000011E   0x.... 0x....      BL       SetLedColor
   \   00000122   0xE7C5             B.N      ??AppTaskStart_5
   \                     ??AppTaskStart_8: (+1)
   \   00000124   0xF64F 0x75FF      MOVW     R5,#+65535
   \   00000128   0x462B             MOV      R3,R5
   \   0000012A   0x2200             MOVS     R2,#+0
   \   0000012C   0x4611             MOV      R1,R2
   \   0000012E   0x4608             MOV      R0,R1
   \   00000130   0x.... 0x....      BL       SetLedColor
   \   00000134   0x462B             MOV      R3,R5
   \   00000136   0x2200             MOVS     R2,#+0
   \   00000138   0x4611             MOV      R1,R2
   \   0000013A   0x2002             MOVS     R0,#+2
   \   0000013C   0x.... 0x....      BL       SetLedColor
   \   00000140   0x462B             MOV      R3,R5
   \   00000142   0x2200             MOVS     R2,#+0
   \   00000144   0x4611             MOV      R1,R2
   \   00000146   0x2001             MOVS     R0,#+1
   \   00000148   0x.... 0x....      BL       SetLedColor
   \   0000014C   0xE7B0             B.N      ??AppTaskStart_5
    402              }
    403          }
    404          
    405          //
    406          ///*******************************************************************************
    407          // * 名    称： App_Init
    408          // * 功    能： 用户应用初始化
    409          // * 入口参数： 无
    410          // * 出口参数： 无
    411          // * 作　 　者： 无名沈.
    412          // * 创建日期： 2015-03-19
    413          // * 修    改：
    414          // * 修改日期：
    415          // *******************************************************************************/
    416          //static void App_Init(void)
    417          //{
    418          //    /********************************************************************
    419          //    * 描述： 初始化EEPROM
    420          //    */
    421          //    App_PraInit();
    422          //    WdtReset();
    423          //    Ctrl.Para.dat.Password  = 0; 
    424          //    /********************************************************************
    425          //    * 描述： 在发布RELEASE版本时，给FLASH加上读保护
    426          //    */
    427          //#ifndef DEBUG
    428          //    /***********************************************
    429          //    * 描述：Flash写保护和读保护，增加保护后，
    430          //    *       需使用JFLASH擦出芯片才可以进行下次下载与仿真。
    431          //    */
    432          //    if( FLASH_GetReadOutProtectionStatus() != SET ){
    433          //        FLASH_Unlock();
    434          //        FLASH_ReadOutProtection(ENABLE);
    435          //        FLASH_Lock();
    436          //    }
    437          //    /***********************************************
    438          //    * 描述：Flash写保护和读保护，增加保护后，
    439          //    *       需使用JFLASH擦出芯片才可以进行下次下载与仿真。
    440          //    */
    441          //#endif
    442          //}
    443          //
    444          /*
    445          ********************************************************************************
    446          *                                      CREATE APPLICATION EVENTS
    447          *
    448          * Description:  This function creates the application kernel objects.
    449          *
    450          * Arguments  :  none
    451          *
    452          * Returns    :  none
    453          ********************************************************************************
    454          */
    455          

   \                                 In section .text, align 2, keep-with-next
    456          static  void  AppObjCreate (void)
    457          {
   \                     AppObjCreate: (+1)
   \   00000000   0xB580             PUSH     {R7,LR}
    458              OS_ERR    err;
    459          
    460              /***********************************************
    461              * 描述：创建看门狗标志组
    462              */
    463              OSFlagCreate(( OS_FLAG_GRP  *)&WdtFlagGRP,
    464                           ( CPU_CHAR     *)"Wdt Flag",
    465                           ( OS_FLAGS      )0,
    466                           ( OS_ERR       *)&err);
   \   00000002   0x466B             MOV      R3,SP
   \   00000004   0x2200             MOVS     R2,#+0
   \   00000006   0x.... 0x....      ADR.W    R1,?_1
   \   0000000A   0x....             LDR.N    R0,??DataTable6_6
   \   0000000C   0x.... 0x....      BL       OSFlagCreate
    467          
    468              /***********************************************
    469              * 描述：创建一个软定时器 OS_OPT_TMR_ONE_SHOT, OS_OPT_TMR_PERIODIC
    470              */
    471              //OSTmrCreate ((OS_TMR               *)&OSTmr0,
    472              //             (CPU_CHAR             *)"tmr0",
    473              //             (OS_TICK               )60 * OS_CFG_TMR_TASK_RATE_HZ,
    474              //             (OS_TICK               )60 * OS_CFG_TMR_TASK_RATE_HZ,
    475              //             (OS_OPT                )OS_OPT_TMR_ONE_SHOT,
    476              //             (OS_TMR_CALLBACK_PTR   )OSTmr0_callback,
    477              //             (void                 *)NULL,
    478              //             (OS_ERR               *)&err);
    479          }
   \   00000010   0xBD01             POP      {R0,PC}          ;; return
    480          
    481          
    482          /*******************************************************************************
    483           * 名    称： OSTmr0_callback
    484           * 功    能： 软定时器0的回调函数
    485           * 入口参数： 无
    486           * 出口参数： 无
    487           * 作　  者： 无名沈
    488           * 创建日期： 2015-03-28
    489           * 修    改：
    490           * 修改日期：
    491           * 备    注： 定时器回调函数不能使用延时函数
    492           *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    493          void OSTmr0_callback(OS_TMR *ptmr,void *p_arg)
    494          {
    495              /***********************************************
    496              * 描述：注意：回调函数中执行的时间不宜过长
    497              */
    498          
    499          }
   \                     OSTmr0_callback: (+1)
   \   00000000   0x4770             BX       LR               ;; return
    500          
    501          /*
    502          ********************************************************************************
    503          *                                      CREATE APPLICATION TASKS
    504          *
    505          * Description:  This function creates the application tasks.
    506          *
    507          * Arguments  :  none
    508          *
    509          * Returns    :  none
    510          ********************************************************************************
    511          */

   \                                 In section .text, align 2, keep-with-next
    512          static  void  AppTaskCreate (void)
    513          {
    514              /***********************************************
    515              * 描述： 在此处创建任务
    516              */
    517          //    extern  void OS_TaskCreateHook(void);
    518          //    OS_TaskCreateHook();
    519              
    520              /***********************************************
    521              * 描述： 在此处创建OSAL任务
    522              */
    523          //#if ( OSAL_EN == DEF_ENABLED )
    524              App_TaskOsalCreate();
   \                     AppTaskCreate: (+1)
   \   00000000   0x.... 0x....      B.W      App_TaskOsalCreate
    525              /***********************************************
    526              * 描述： 在此处创UCOS建任务
    527              */
    528          //#else
    529          //    App_TaskSensorCreate();
    530          //    //App_TaskControlCreate();
    531          //#endif
    532          }
    533          
    534          
    535          /*******************************************************************************
    536          * 名    称： OSSetWdtFlag
    537          * 功    能： 任务喂狗
    538          * 入口参数： 无
    539          * 出口参数： 无
    540          * 作    者： 无名沈
    541          * 创建日期： 2017/11/18
    542          * 修    改： 
    543          * 修改日期： 
    544          * 备    注： 
    545          *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    546          void OSRegWdtFlag( OS_FLAGS flag )
    547          {
    548              /***********************************************
    549              * 描述： 在看门狗标志组注册本任务的看门狗标志
    550              */
    551              WdtFlags |= flag;
   \                     OSRegWdtFlag: (+1)
   \   00000000   0x....             LDR.N    R1,??DataTable6_5
   \   00000002   0x680A             LDR      R2,[R1, #+0]
   \   00000004   0x4310             ORRS     R0,R0,R2
   \   00000006   0x6008             STR      R0,[R1, #+0]
    552          }
   \   00000008   0x4770             BX       LR               ;; return
    553          
    554          /*******************************************************************************
    555          * 名    称： OSSetWdtFlag
    556          * 功    能： 任务喂狗
    557          * 入口参数： 无
    558          * 出口参数： 无
    559          * 作    者： 无名沈
    560          * 创建日期： 2017/11/18
    561          * 修    改： 
    562          * 修改日期： 
    563          * 备    注： 
    564          *******************************************************************************/

   \                                 In section .text, align 2, keep-with-next
    565          void OSSetWdtFlag( OS_FLAGS flag )
    566          {
   \                     OSSetWdtFlag: (+1)
   \   00000000   0xB580             PUSH     {R7,LR}
    567              OS_ERR    err;
    568              
    569              /***********************************************
    570              * 描述： 本任务看门狗标志置位
    571              */
    572              OSFlagPost(( OS_FLAG_GRP  *)&WdtFlagGRP,
    573                          ( OS_FLAGS     ) flag,
    574                          ( OS_OPT       ) OS_OPT_POST_FLAG_SET,
    575                          ( OS_ERR      *) &err);
   \   00000002   0x466B             MOV      R3,SP
   \   00000004   0x2200             MOVS     R2,#+0
   \   00000006   0x4601             MOV      R1,R0
   \   00000008   0x....             LDR.N    R0,??DataTable6_6
   \   0000000A   0x.... 0x....      BL       OSFlagPost
    576          }
   \   0000000E   0xBD01             POP      {R0,PC}          ;; return

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6:
   \   00000000   0x1FFFF7E0         DC32     0x1ffff7e0

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_1:
   \   00000000   0x........         DC32     AppTaskStartTCB

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_2:
   \   00000000   0x08010000         DC32     0x8010000

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_3:
   \   00000000   0xE000ED08         DC32     0xe000ed08

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_4:
   \   00000000   0x........         DC32     OSCfg_TickRate_Hz

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_5:
   \   00000000   0x........         DC32     WdtFlags

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable6_6:
   \   00000000   0x........         DC32     WdtFlags+0x4

   \                                 In section .text, align 4, keep-with-next
   \                     ?_0:
   \   00000000   0x41 0x70          DC8 "App Task Start"
   \              0x70 0x20    
   \              0x54 0x61    
   \              0x73 0x6B    
   \              0x20 0x53    
   \              0x74 0x61    
   \              0x72 0x74    
   \              0x00         
   \   0000000F   0x00               DC8 0

   \                                 In section .text, align 4, keep-with-next
   \                     ?_1:
   \   00000000   0x57 0x64          DC8 "Wdt Flag"
   \              0x74 0x20    
   \              0x46 0x6C    
   \              0x61 0x67    
   \              0x00         
   \   00000009   0x00 0x00          DC8 0, 0, 0
   \              0x00         
    577          
    578          /*******************************************************************************
    579           * 				end of file
    580           *******************************************************************************/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       8   AppObjCreate
         8   -> OSFlagCreate
       0   AppTaskCreate
         0   -> App_TaskOsalCreate
      32   AppTaskStart
        32   -> AppObjCreate
        32   -> AppTaskCreate
        32   -> App_OS_SetAllHooks
        32   -> App_TaskCommCreate
        32   -> App_TaskMeasureCreate
        32   -> BSP_CPU_ClkFreq
        32   -> BSP_Init
        32   -> BSP_WDT_Init
        32   -> BSP_WDT_Rst
        32   -> CPU_Init
        32   -> CPU_IntDisMeasMaxCurReset
        32   -> Delay_Nms
        32   -> OSFlagPend
        32   -> OSTimeDly
        32   -> OSTimeGet
        32   -> OS_CPU_SysTickInit
        32   -> OS_FlagPost
        32   -> SetLedColor
       0   OSRegWdtFlag
       8   OSSetWdtFlag
         8   -> OSFlagPost
       0   OSTmr0_callback
      48   main
        48   -> App_Main
        48   -> OSInit
        48   -> OSStart
        48   -> OSTaskCreate


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable6
       4  ??DataTable6_1
       4  ??DataTable6_2
       4  ??DataTable6_3
       4  ??DataTable6_4
       4  ??DataTable6_5
       4  ??DataTable6_6
      16  ?_0
      12  ?_1
      18  AppObjCreate
       4  AppTaskCreate
     334  AppTaskStart
     440  AppTaskStartTCB
          AppTaskStartStk
      10  OSRegWdtFlag
      16  OSSetWdtFlag
      44  OSTmr0
       2  OSTmr0_callback
      32  WdtFlags
          WdtFlagGRP
      94  main

 
 516 bytes in section .bss
 534 bytes in section .text
 
 534 bytes of CODE memory
 516 bytes of DATA memory

Errors: none
Warnings: 1
